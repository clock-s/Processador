#!/bin/bash

# Script para compilar programa assembly e preparar para simula√ß√£o
# Autor: Sistema de Processador 8-bits
# Data: 31 de Outubro de 2025

echo "=================================================="
echo "  COMPILADOR DE PROGRAMAS PARA O PROCESSADOR"
echo "=================================================="
echo ""

# Diret√≥rios
COMPILER_DIR="./Compiler"
PROGRAM_FILE="${1:-teste_basico.gbf}"
OUTPUT_FILE="teste.bin"

# Verifica se o arquivo de entrada existe
if [ ! -f "$COMPILER_DIR/$PROGRAM_FILE" ]; then
    echo "‚ùå ERRO: Arquivo $PROGRAM_FILE n√£o encontrado em $COMPILER_DIR/"
    echo ""
    echo "Uso: $0 [arquivo.gbf]"
    echo "Exemplo: $0 teste_basico.gbf"
    exit 1
fi

# Entra no diret√≥rio do compilador
cd "$COMPILER_DIR" || exit 1

echo "üìù Arquivo de entrada: $PROGRAM_FILE"
echo ""

# Compila o compilador se necess√°rio
if [ ! -f "compiler" ]; then
    echo "üî® Compilando o compilador C++..."
    g++ -o compiler compiler.cpp
    
    if [ $? -ne 0 ]; then
        echo "‚ùå ERRO: Falha ao compilar o compilador"
        exit 1
    fi
    echo "‚úÖ Compilador C++ compilado com sucesso"
    echo ""
fi

# Executa o compilador
echo "‚öôÔ∏è  Compilando programa assembly..."
./compiler "$PROGRAM_FILE" "$OUTPUT_FILE"

if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå ERRO: Falha ao compilar o programa"
    exit 1
fi

echo ""
echo "‚úÖ Programa compilado com sucesso!"
echo ""
echo "üì¶ Arquivo bin√°rio gerado: $OUTPUT_FILE"
echo ""

# Mostra o conte√∫do do arquivo bin√°rio
echo "üìã Conte√∫do do arquivo bin√°rio (hexadecimal):"
echo "--------------------------------------------"
cat "$OUTPUT_FILE"
echo "--------------------------------------------"
echo ""

# Conta instru√ß√µes
NUM_BYTES=$(wc -l < "$OUTPUT_FILE")
echo "üìä Total de bytes: $NUM_BYTES"
echo ""

echo "‚úÖ Pronto para simula√ß√£o!"
echo ""
echo "Pr√≥ximos passos:"
echo "  1. Certifique-se de que teste.bin est√° em Compiler/"
echo "  2. Execute a simula√ß√£o com seu simulador VHDL preferido"
echo "  3. Use o testbench: testbench_PROCESSOR.vhd"
echo ""

cd - > /dev/null
